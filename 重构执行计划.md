# Flora 多智能体协作系统重构执行计划

## 目标概述
基于`重构方案.md`文档，制定具体的重构执行计划，修复现有并行执行机制中的问题，并逐步实现系统架构优化

## 第一阶段：核心架构重构（4周）

### 第1周：并行执行机制修复与重构准备

#### 1.1 整体架构完善
明确有多少文件夹，每个文件夹下哪些文件，每个文件做什么用，关键实现是什么

#### 1.2 架构设计文档完善
- 细化每个组件的接口定义和职责边界
- 制定插件化接口标准文档
- 明确组件间通信协议

### 第2周：AgentActor核心重构

#### 2.0修复并行执行机制中的关键问题
- 修改`agent/concurrent/concurrent_actor.py`文件：
  - 删除重复的`receiveMessage`方法定义
  - 将`VideoWorker`替换为`AgentActor`
  - 修正`OptimizationOrchestrator`类的实现，确保正确的任务分发和结果聚合
  - 修复导入缺失问题（如`LLMOrchestrator`、`optuna`等）
#### 2.1 重构AgentActor类
- 移除过重的职责，为后续组件拆分做准备
- 完善记忆机制

#### 2.2 实现AgentActor与并行执行的集成
- 在`AgentActor`中添加并行执行管理器组件
- 实现`_run_optimization_cycle`方法，连接到并行执行机制
- 确保任务执行路径正确

### 第3-4周：TaskCoordinator拆分

#### 3.1 创建TaskRouter组件
- 从`TaskCoordinator`中提取路由逻辑和基于能力的actor选择算法
- 创建`TaskRouter`组件
- 实现基于能力选择算法接口，方便后续修改
- 定义清晰的接口

#### 3.2 创建TaskPlanner组件
- 从`TaskCoordinator`中提取子任务规划逻辑
- 实现与外部decision_engine的正确集成
- 定义任务规划接口

#### 3.3 创建ContextResolver组件
- 从`TaskCoordinator`中提取上下文解析逻辑
- 实现数据补充和上下文丰富功能
- 定义上下文解析接口

#### 3.4 更新AgentActor以使用新组件
- 修改`AgentActor`依赖，使用新拆分的组件
- 更新任务处理流程
- 确保向后兼容性

## 第二阶段：任务执行模型优化（3周）

### 第5周：循环任务管理器实现

#### 5.1 设计循环任务数据结构
- 定义循环任务模型
- 实现持久化接口

#### 5.2 实现循环任务管理器
- 创建循环任务调度逻辑
- 实现任务归属到具体agent_actor的机制
- 集成事件报告功能

### 第6-7周：并行执行管理器完善

#### 6.1 完善OptimizationOrchestrator
- 修正任务分发逻辑，确保正确使用AgentActor
- 实现资源评估机制
- 优化结果聚合算法

#### 6.2 实现智能并行决策机制
- 开发任务并行性评估算法
- 实现由agent_actor自主决定并行策略的功能
- 集成Optuna优化流程

#### 6.3 优化并行执行性能
- 实现资源监控和自适应调度
- 优化任务拆分和结果合并机制
- 性能测试和调优

## 第三阶段：系统集成与测试（2周）

### 第8周：插件化接口实现

#### 8.1 实现外部对接层接口标准
- 创建插件化接口框架
- 实现持久化、外部数据库、外部API、dify等连接的标准接口

#### 8.2 实现底层能力层接口标准
- 创建能力插件接口
- 实现各种基础能力的标准化包装

### 第9周：集成测试

#### 9.1 单元测试
- 为所有核心组件编写单元测试
- 覆盖关键功能和边缘情况

#### 9.2 集成测试
- 测试组件间的协作
- 验证完整任务执行流程
- 模拟各种异常场景

#### 9.3 性能测试
- 测试系统在不同负载下的性能
- 优化瓶颈点

## 第四阶段：部署与监控（1周）

### 第10周：部署准备与系统监控

#### 10.1 部署方案准备
- 制定蓝绿部署或金丝雀发布策略
- 准备回滚方案

#### 10.2 实现系统监控和日志记录
- 集成监控工具
- 实现关键指标的日志记录
- 配置告警机制

#### 10.3 系统稳定性测试
- 进行长时间运行测试
- 模拟故障恢复场景
- 最终验证系统功能和性能

## 详细技术实现计划

### 1. 修复并行执行机制中的VideoWorker问题

**文件修改**: `agent/concurrent/concurrent_actor.py`

**具体修改**:
1. 合并重复的`receiveMessage`方法
2. 将`VideoWorker`替换为`AgentActor`
3. 修正消息格式，使其与`AgentActor`兼容
4. 修复导入缺失的问题

**实现代码示例**:
```python
# 替换原有的VideoWorker创建和消息发送逻辑
for inst, tnum in zip(instructions, trial_numbers):
    worker = self.createActor(AgentActor)
    # 为AgentActor准备初始化消息
    init_msg = InitMessage(
        agent_id=f"parallel_worker_{tnum}",
        capabilities=["execute_parallel_task"],  # 根据实际需求设置
        memory_key=f"parallel_worker_{tnum}",
        registry=getattr(self, 'registry', None)  # 确保有registry引用
    )
    self.send(worker, init_msg)
    # 发送任务消息
    self.send(worker, TaskMessage(
        task_id=f"trial_{tnum}",
        context={"instruction": inst, "trial_number": tnum, "report_to": self.myAddress}
    ))
```

### 2. TaskCoordinator拆分实现

**创建新文件**:
- `agent/coordination/task_router.py`
- `agent/coordination/task_planner.py`
- `agent/coordination/context_resolver.py`

**实现TaskRouter**:
```python
class TaskRouter:
    def __init__(self, registry):
        self.registry = registry
    
    def select_best_actor(self, parent_agent_id, context):
        # 实现基于能力的actor选择逻辑
        # ...
        return selected_agent_id
```

### 3. AgentActor与并行执行的集成

**修改文件**: `agent/agent_actor.py`

**添加并行执行管理器**:
```python
# 在AgentActor类中添加
from .concurrent.concurrent_actor import OptimizationOrchestrator

class AgentActor(Actor):
    def __init__(self):
        # ... 现有代码 ...
        self._parallel_execution_manager = None
    
    def _handle_init(self, msg: InitMessage):
        # ... 现有代码 ...
        # 初始化并行执行管理器
        if not self._is_leaf:
            self._parallel_execution_manager = OptimizationOrchestrator()
    
    def _should_execute_in_parallel(self, task_id, context):
        # 判断任务是否适合并行执行
        # 基于任务类型、历史数据等
        # ...
        return False  # 示例返回值
    
    def _execute_in_parallel(self, task_id, context, sender):
        # 使用并行执行管理器执行任务
        # ...
        pass
    
    def _run_optimization_cycle(self):
        try:
            # 实现优化循环逻辑
            # 1. 收集需要优化的任务
            # 2. 使用并行执行管理器执行优化
            # 3. 收集结果并更新策略
            # ...
        except Exception as e:
            logger.exception(f"Optimization cycle failed for {self.agent_id}: {e}")
```

## 风险与应对策略

1. **VideoWorker替换风险**:
   - 风险：`AgentActor`与`VideoWorker`接口不兼容
   - 应对：创建适配器模式，确保消息格式和处理逻辑兼容

2. **组件拆分风险**:
   - 风险：组件拆分可能引入新的集成问题
   - 应对：逐步拆分，每个步骤进行全面测试

3. **性能风险**:
   - 风险：重构后性能下降
   - 应对：建立性能基准，持续监控关键指标

4. **兼容性风险**:
   - 风险：与现有系统不兼容
   - 应对：维护接口兼容性，提供兼容层

## 验收标准

1. 并行执行机制能够正常工作，不再依赖`VideoWorker`类
2. 系统能够按照树形结构正确传递和处理任务
3. 所有组件能够通过单元测试和集成测试
4. 系统性能达到或超过重构前水平
5. 代码质量符合项目规范，组件职责清晰
6. 系统稳定性达到生产环境要求

## 文件体系变更

按照重构方案中定义的六个层次，重新组织文件体系结构，合理利用现有目录并满足系统架构需求。

### 1. 入口层（entry_layer/）- 新增

**功能**：系统外部访问入口，负责接收用户请求并转发到对应租户的根 actor

**新增文件**：
- `entry_layer/__init__.py`
- `entry_layer/api_server.py` - API服务器实现
- `entry_layer/request_handler.py` - 请求处理器
- `entry_layer/tenant_router.py` - 租户路由分发器
- `entry_layer/auth_middleware.py` - 认证中间件

### 2. 外部对接层（external/）- 新增

**功能**：底层能力层与外部系统的对接层，负责连接持久化、外部数据库、外部API、dify等，采用插件化设计方便切换

**新增文件**：
- `external/__init__.py`
- `external/adapter_base.py` - 适配器基类
- `external/database/` - 数据库适配器
  - `external/database/__init__.py`
  - `external/database/db_interface.py` - 数据库连接抽象接口
  - `external/database/mysql_adapter.py` - 基于现有mysql_pool.py实现的连接池管理，支持多数据库选择
  - `external/database/neo4j_adapter.py`
  - `external/database/postgres_adapter.py` - 新增PostgreSQL支持
  - `external/database/vanna/` - Vanna文本到SQL集成（抽象化）
    - `external/database/vanna/__init__.py`
    - `external/database/vanna/vanna_base.py` - Vanna抽象基类
    - `external/database/vanna/qwen_integration.py` - Qwen模型集成
    - `external/database/vanna/chatgpt_integration.py` - 新增ChatGPT模型集成
    - `external/database/vanna/llama_integration.py` - 新增Llama模型集成
    - `external/database/vanna/model_factory.py` - 模型工厂，动态创建不同LLM的Vanna实例
- `external/api/` - API适配器
  - `external/api/__init__.py`
  - `external/api/rest_client.py`
  - `external/api/graphql_client.py`
- `external/dify/` - Dify适配器（整合现有的action_implementations/dify_connector.py）
  - `external/dify/__init__.py`
  - `external/dify/connector.py`
  - `external/dify/schema_parser.py`

### 3. 底层能力层（capabilities/）- 新增

**功能**：提供各种基础能力，位于外部连接层之上，采用插件化设计，方便actor加载

**整合现有模块**：
- 利用现有的 `llm_memory_system/` - 记忆能力
- 利用现有的 `multifeature/` - 自学习和优化能力

**新增文件**：
- `capabilities/__init__.py`
- `capabilities/capability_base.py` - 能力基类
- `capabilities/registry.py` - 能力注册表
- `capabilities/llm/` - 语言模型能力
  - `capabilities/llm/__init__.py`
  - `capabilities/llm/qwen_adapter.py`
- `capabilities/decision/` - 决策能力
  - `capabilities/decision/__init__.py`
  - `capabilities/decision/engine_adapter.py`

### 4. 能力 actor 层（capability_actors/）- 新增

**功能**：作为底层能力与actor系统之间的转换层，包装底层能力使其能在actor系统中使用

**整合现有文件**：
- 从 `agent/` 目录迁移和重构相关文件

**新增文件**：
- `capability_actors/__init__.py`
- `capability_actors/memory_actor.py` - 记忆能力的Actor包装（重构自agent/memory/memory_actor.py）
- `capability_actors/data_actor.py` - 数据访问能力的Actor包装（重构自agent/io/data_actor.py）
- `capability_actors/mcp_actor.py` - MCP能力的Actor包装（迁移自agent/mcp/mcp_actor.py）
- `capability_actors/dify_actor.py` - Dify能力的Actor包装（迁移自agent/excute/dify_actor.py）

### 5. agent_actor 层（agents/）- 重构现有agent目录

**功能**：系统核心，负责任务处理、决策和向下传递，以树形结构组织

**重命名**：`agent/` -> `agents/`

**修改现有文件**：
- `agents/agent_actor.py` - 重构核心类，集成并行执行管理器
- `agents/agent_registry.py` - 保留并优化

**新增目录结构**：
- `agents/tree/` - 树形结构管理（基于现有的AgentRegistry）
  - `agents/tree/__init__.py`
  - `agents/tree/tree_manager.py` - 封装AgentRegistry，提供高级树形操作
  - `agents/tree/node_service.py` - 节点服务，与Neo4j交互（保留现有的AgentRegistry）
  - `agents/tree/relationship_service.py` - 关系服务，管理父子关系
- `agents/execution/` - 执行相关
  - `agents/execution/__init__.py`
  - `agents/execution/task_processor.py`
  - `agents/execution/result_aggregator.py`
- `agents/coordination/` - 任务协调（拆分TaskCoordinator）
  - `agents/coordination/task_router.py` - 任务路由器
  - `agents/coordination/task_planner.py` - 任务规划器
  - `agents/coordination/context_resolver.py` - 上下文解析器
- `agents/parallel/` - 并行执行（替代concurrent目录）
  - `agents/parallel/__init__.py`
  - `agents/parallel/orchestrator.py` - 并行执行协调器（重构自concurrent_actor.py）
  - `agents/parallel/dimension_parser.py` - 维度解析器（迁移自llm_demension_parser.py）
  - `agents/parallel/execution_manager.py` - 并行执行管理器
- `agents/optimization/` - 优化相关（保留并优化）
  - `agents/optimization/optimizer.py`
  - `agents/optimization/optimization_task.py`
  - `agents/optimization/optimization_strategy.py`
  - `agents/optimization/resource_monitor.py`
- `agents/data/` - 数据访问（替代io目录）
  - `agents/data/__init__.py`
  - `agents/data/data_actor.py` - 重构自agent/io/data_actor.py，负责数据查询处理，支持多数据库和多模型
  - `agents/data/data_routing_actor.py` - 数据路由处理，支持基于数据库类型的路由
  - `agents/data/query_processor.py` - 重构自data_query_actor.py，增强的查询处理
  - `agents/data/utils.py` - 工具函数（迁移自agent/io/utils.py）
  - `agents/data/cache.py` - 新增缓存机制
  - `agents/data/db_factory.py` - 数据库工厂，动态创建不同类型数据库的连接适配器
  - `agents/data/vanna_factory.py` - Vanna实例工厂，根据配置选择合适的模型集成
  - `agents/data/config_manager.py` - 数据访问配置管理器，支持动态配置切换

### 6. 事件报告层（events/）- 重构Observer

**功能**：统一的事件发布和订阅机制

**整合现有模块**：利用现有的 `Observer/` 目录

**重命名和重构**：`Observer/` -> `events/`

**修改现有文件**：
- `events/observer_actor.py` - 重命名为`events/event_actor.py`并重构
- `events/task_event.py` - 保留并扩展

**新增文件**：
- `events/__init__.py`
- `events/event_bus.py` - 事件总线
- `events/event_types.py` - 事件类型定义
- `events/subscriber.py` - 订阅者接口
- `events/publisher.py` - 发布者接口

### 7. 公共配置与工具（common/）- 新增

**功能**：提供公共配置、工具类和常量定义

**整合现有文件**：
- 从 `agent/config/` 迁移配置相关文件

**新增目录结构**：
- `common/__init__.py`
- `common/config/`
  - `common/config/config_manager.py`
  - `common/config/plugin_config.py`
  - `common/config/parallel_config.py`
  - `common/config/resources_config.py`
- `common/utils/`
  - `common/utils/__init__.py`
  - `common/utils/logger.py`
  - `common/utils/serializer.py`
  - `common/utils/validator.py`
- `common/messages/` - 消息定义（迁移自agent/message.py）
  - `common/messages/__init__.py`
  - `common/messages/base_message.py`
  - `common/messages/task_messages.py`
  - `common/messages/optimization_messages.py`

### 8. 主程序入口（保持不变）

**保留和修改**：
- `main.py` - 主程序入口，更新以使用新的目录结构
- `init_global_components.py` - 初始化全局组件，更新以使用新的目录结构

### 9. 数据库与文本到SQL能力实现

**功能**：提供多数据库访问支持和基于多种大模型的文本到SQL转换能力，实现数据库和模型的抽象与动态切换

**实现细节**：

#### 9.1 多数据库抽象与连接管理
- 在`external/database/db_interface.py`中定义统一的数据库接口，包含连接获取、SQL执行、结果处理等标准方法
- 实现多种数据库适配器：
  - `mysql_adapter.py`：基于现有`mysql_pool.py`实现单例模式连接池，支持多数据库选择
  - `postgres_adapter.py`：新增PostgreSQL支持，实现相同接口
  - `neo4j_adapter.py`：图数据库支持，适配Neo4j特有的查询语言
- 在`agents/data/db_factory.py`中实现工厂模式，根据配置动态创建不同类型数据库的连接适配器
- 支持运行时数据库切换，通过配置变更无需重启服务

#### 9.2 多模型Vanna文本到SQL抽象框架
- 在`external/database/vanna/vanna_base.py`中定义统一的Vanna抽象基类，规定标准接口
- 实现多种LLM集成：
  - `qwen_integration.py`：集成通义千问大模型，保留现有的功能
  - `chatgpt_integration.py`：新增ChatGPT模型集成，支持GPT系列模型
  - `llama_integration.py`：新增Llama模型集成，支持开源大模型部署
- 在`external/database/vanna/model_factory.py`中实现模型工厂，根据配置动态创建不同LLM的Vanna实例
- 统一使用ChromaDB作为向量存储，按业务ID隔离不同业务的知识库，保持知识隔离性

#### 9.3 配置管理与动态切换
- 在`agents/data/config_manager.py`中实现集中化的配置管理
- 支持数据库类型、连接参数、模型选择、向量存储参数等配置的动态管理
- 提供配置热更新机制，支持运行时切换数据库或模型
- 实现配置验证和错误处理，确保配置变更的安全性

#### 9.4 统一查询处理流程
1. `agents/data/data_routing_actor.py`负责接收和路由数据查询请求，根据请求参数和配置选择合适的数据处理器
2. `agents/data/data_actor.py`处理具体查询，通过依赖注入使用不同的数据库适配器和Vanna实例：
   - 根据配置初始化相应的Vanna模型实例
   - 加载表结构并进行增强处理
   - 使用记忆增强查询（如配置开启）
   - 生成SQL并通过数据库适配器执行
   - 统一的安全审核和结果处理
3. `agents/data/query_processor.py`提供增强的查询处理能力：
   - SQL语法分析和优化
   - 查询结果缓存
   - 复杂查询的分解和重组
4. 自动学习机制：成功的查询会自动加入相应业务的知识库，支持跨模型知识共享（可选）

## 文件体系调整总结

### 主要变更

1. **按照六层架构重新组织**：严格按照重构方案中定义的六个层次组织文件体系
2. **合理利用现有模块**：整合Observer、multifeature、llm_memory_system等现有模块
3. **目录重命名与重构**：
   - `agent/` -> `agents/`
   - `agent/io/` -> `agents/data/`
   - `Observer/` -> `events/`
   - `agent/concurrent/` -> `agents/parallel/`
   - 保留并增强`agent/agent_registry.py`，将其作为树形结构管理的核心组件
4. **新增专用目录**：entry_layer、external、capabilities、capability_actors、common

### 架构优势

1. **职责清晰**：每个目录对应明确的架构层次和功能职责
2. **模块化**：各层之间通过明确的接口通信，降低耦合度
3. **可扩展性**：采用插件化设计，方便添加新的能力和外部系统对接
4. **可维护性**：清晰的目录结构和文件组织，便于开发和维护
5. **系统一致性**：统一的事件报告、配置管理和工具类

### 关键技术实现点

1. **并行执行机制修复**：在`agents/parallel/orchestrator.py`中实现，使用AgentActor替代不存在的VideoWorker
2. **任务协调器拆分**：在`agents/coordination/`目录下实现三个独立组件
3. **插件化接口**：在`capabilities/`和`external/`目录中实现标准化的插件接口
4. **树形结构管理**：保留并增强现有的`AgentRegistry`类，在`agents/tree/`目录中构建服务层，提供高级树形操作而不重复实现Neo4j交互逻辑
5. **事件驱动架构**：在`events/`目录中实现统一的事件发布和订阅机制
6. **多数据库抽象设计**：在`external/database/db_interface.py`中定义统一的数据库接口，通过`external/database/mysql_adapter.py`、`external/database/postgres_adapter.py`等实现多种数据库支持，采用工厂模式在`agents/data/db_factory.py`中动态创建连接适配器，支持运行时数据库切换
7. **多模型文本到SQL转换框架**：在`external/database/vanna/`目录下实现抽象化的Vanna集成，包括统一基类、模型工厂和多种LLM实现（Qwen、ChatGPT、Llama），支持基于配置动态选择大模型，保持业务逻辑与具体模型实现解耦
8. **数据访问配置管理**：在`agents/data/config_manager.py`中实现动态配置管理，支持运行时切换数据库类型、模型选择和向量存储参数，无需重启服务
9. **统一查询处理流程**：增强`agents/data/data_actor.py`和`agents/data/query_processor.py`，实现与具体数据库和模型无关的查询处理流程，通过依赖注入使用不同的适配器

通过这种文件体系的调整，系统将更加符合重构方案中定义的架构设计，实现更加清晰、可维护和可扩展的多智能体协作系统。

---

本执行计划将确保Flora系统重构工作有序进行，重点解决并行执行机制中的关键问题，并实现重构方案中的所有目标。