# 系统重构计划

## 1. 重构背景与目标

### 1.1 核心问题分析
根据重构方案文档，当前系统存在以下核心问题：

| 问题类型 | 具体表现 | 影响 |
|---------|---------|------|
| 调用链过长 | AgentActor -> TaskExecutionService -> ExecutionActor -> UniversalConnectorOrchestrator -> DifyConnector | 调试困难，消息传递复杂，容易出错 |
| Actor与Service边界模糊 | Agents文件夹混杂Actor和纯逻辑类，TaskExecutionService持有ExecutionActor | 异步调用与同步逻辑混用，可能导致死锁或回调地狱 |
| 功能模块过度拆分 | 多个功能相似的聚合器Actor，记忆层级重复 | 维护成本高，数据传递易丢失 |
| 层级依赖混乱 | Common层依赖上层模块，如Intent识别依赖LLM | 违反分层原则，系统耦合度高 |
| 状态管理不当 | 草稿状态仅存储在内存中，系统重启后丢失 | 数据不可靠，用户体验差 |

### 1.2 重构目标
- **简化调用链**：减少中间层，实现扁平化执行
- **明确边界**：清晰区分Actor（异步）和Service（同步）职责
- **整合功能**：合并相似模块，减少代码冗余
- **优化分层**：确保依赖关系合理，Common层不依赖上层
- **改进状态管理**：实现草稿状态持久化

## 2. 重构范围

### 2.1 涉及模块
- **Agents层**：agent_actor.py, task_coordinator.py, tree_manager.py, agent_registry.py
- **Capabilities Actor层**：execution_actor.py, task_execution_service.py, universal_connector_orchestrator.py, task_group_aggregator_actor.py
- **Capabilities层**：context_resolver.py, connector_manager.py, registry.py
- **Common层**：conversation_manager.py, intent_router.py, messages/task_messages.py

### 2.2 不涉及模块
- 外部依赖的API客户端（如DifyConnector）
- 基础工具类和配置文件

## 3. 重构原则

1. **单一职责**：每个模块只负责一个核心功能
2. **清晰边界**：Actor（异步消息驱动）与Service（同步逻辑）分离
3. **依赖倒置**：高层模块不依赖低层模块的具体实现
4. **可测试性**：重构后代码便于单元测试和集成测试
5. **渐进式重构**：分阶段实施，确保系统稳定性

## 4. 分阶段实施计划

### 4.1 第一阶段：核心执行链路重构（2周）

**目标**：简化执行调用链，实现AgentActor与ExecutionActor的直接通信

**具体任务**：

| 任务 | 负责人 | 完成标准 |
|------|--------|----------|
| 统一数据传输协议 | 架构师 | 在common/messages/task_messages.py中定义AgentTaskMessage和TaskExecutionResult |
| 降级UniversalConnectorOrchestrator | 开发工程师 | 将其改为普通类，移动到capabilities/connectors/connector_manager.py |
| 重构execution_actor.py | 开发工程师 | 集成ConnectorManager和ContextResolver，直接处理执行逻辑 |
| 删除TaskExecutionService | 开发工程师 | 将其逻辑并入AgentActor和ExecutionActor |
| 修改agent_actor.py | 开发工程师 | 实现直接调用ExecutionActor的逻辑，包括叶子节点判断 |
| 测试执行链路 | 测试工程师 | 验证重构后的执行流程正常工作 |

### 4.2 第二阶段：任务管理与聚合重构（2周）

**目标**：优化任务规划、分发和聚合逻辑

**具体任务**：

| 任务 | 负责人 | 完成标准 |
|------|--------|----------|
| 重构TaskGroupAggregatorActor | 开发工程师 | 实现递归调用子AgentActor的逻辑，集成Optuna优化 |
| 优化TaskCoordinator | 开发工程师 | 移至Common/Tasks或Capabilities/Decision，明确职责 |
| 合并AgentRegistry和TreeManager | 开发工程师 | 统一管理Agent结构和注册信息 |
| 实现双模式AgentActor | 开发工程师 | 支持Manager模式（分发任务）和Worker模式（执行任务） |
| 测试任务分发与聚合 | 测试工程师 | 验证复杂任务的分解和聚合流程 |

### 4.3 第三阶段：状态管理与意图识别重构（1周）

**目标**：改进草稿状态管理和意图识别逻辑

**具体任务**：

| 任务 | 负责人 | 完成标准 |
|------|--------|----------|
| 实现ConversationManager持久化 | 开发工程师 | 将草稿状态存储到Redis或DB，支持系统重启恢复 |
| 迁移Intent模块 | 开发工程师 | 从Common层移至Capabilities/Decision，避免循环依赖 |
| 优化Intent识别逻辑 | 开发工程师 | 通过依赖注入方式传入LLM Client |
| 测试状态管理 | 测试工程师 | 验证草稿状态的持久化和恢复功能 |

### 4.4 第四阶段：清理与优化（1周）

**目标**：清理冗余代码，优化系统性能

**具体任务**：

| 任务 | 负责人 | 完成标准 |
|------|--------|----------|
| 删除冗余Actor和Service | 开发工程师 | 清理不再使用的模块，如MemoryCapabilityActor |
| 优化EventBus集成 | 开发工程师 | 确保所有模块能方便调用EventBus |
| 代码审查与优化 | 架构师 | 确保代码符合设计原则和编码规范 |
| 性能测试 | 测试工程师 | 验证重构后系统性能是否提升 |

### 4.5 第五阶段：集成测试与上线（1周）

**目标**：确保重构后系统稳定运行

**具体任务**：

| 任务 | 负责人 | 完成标准 |
|------|--------|----------|
| 集成测试 | 测试工程师 | 验证所有模块协同工作正常 |
| 用户验收测试 | 产品经理 | 验证核心功能符合用户需求 |
| 灰度发布 | 运维工程师 | 逐步将重构后的系统推向生产环境 |
| 监控与优化 | 运维工程师 | 监控系统运行状态，及时处理问题 |

## 5. 验收标准

1. **功能完整性**：重构后所有原有功能正常运行
2. **性能提升**：系统响应时间减少20%以上
3. **可维护性**：代码复杂度降低，模块职责清晰
4. **可测试性**：代码覆盖率达到80%以上
5. **稳定性**：系统在高负载下稳定运行，无内存泄漏或死锁

## 6. 风险识别与应对措施

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 重构过程中引入新bug | 系统稳定性下降 | 采用渐进式重构，每个阶段完成后进行充分测试 |
| Actor引用序列化问题 | 跨进程通信失败 | 在Redis中存储Actor的Address字符串，而非直接序列化ActorRef |
| 异步与同步调用混用 | 死锁或性能问题 | 明确区分Actor和Service的调用方式，避免混合使用 |
| 依赖关系复杂 | 重构难度大 | 先梳理依赖关系图，从依赖最少的模块开始重构 |
| 测试覆盖不足 | 隐藏bug未被发现 | 增加单元测试和集成测试，使用自动化测试工具 |

## 7. 资源需求

- **开发人员**：2-3名，熟悉Actor模型和Python开发
- **测试人员**：1-2名，熟悉系统功能和测试流程
- **架构师**：1名，负责设计指导和代码审查
- **运维人员**：1名，负责部署和监控

## 8. 预期收益

1. **开发效率提升**：简化的架构便于新功能开发和维护
2. **系统性能提升**：减少中间层，降低消息传递开销
3. **调试难度降低**：扁平化的调用链便于问题定位
4. **扩展性增强**：清晰的模块边界便于系统扩展
5. **用户体验改善**：草稿状态持久化，避免数据丢失

## 9. 后续优化建议

1. **引入监控系统**：实时监控Actor状态和消息流量
2. **实现Actor池化**：优化Actor创建和销毁开销
3. **引入配置中心**：集中管理系统配置，支持动态更新
4. **增强容错机制**：实现Actor故障自动恢复
5. **优化数据存储**：根据数据特性选择合适的存储方案

---

**计划制定日期**：2025-11-28
**计划执行日期**：2025-12-01 至 2025-12-26
**负责人**：架构师团队