# Flora 多智能体协作系统 - 架构文档

## 1. 整体架构概述

Flora是一个基于Actor模型的多智能体协作系统，采用树形结构组织智能体，支持并行执行和任务优化。系统实现了记忆、决策、数据处理等核心功能，并通过事件机制实现组件间通信。

## 2. 文件目录结构

### 2.1 根目录文件
- **main.py**: 系统主入口点
- **init_global_components.py**: 全局组件初始化脚本
- **Florareadme.md** / **ReadMe.md**: 项目说明文档
- **.gitignore**: Git忽略配置文件
- **重构方案.md**: 重构设计方案文档
- **重构执行计划.md**: 重构实施计划文档

### 2.2 核心目录分析

#### Observer/
观察者模块，负责事件发布与订阅
- **observer_actor.py**: 事件观察者Actor实现
- **task_event.py**: 任务事件定义

#### action_implementations/
动作实现模块，提供具体能力的实现
- **dify_connector.py**: Dify平台连接器实现

#### agent/
智能体核心模块，系统的核心实现
- **__init__.py**: 模块初始化
- **agent_actor.py**: AgentActor基类，智能体的核心实现
- **agent_registry.py**: 智能体注册表，管理树形结构中的智能体
- **message.py**: 消息定义

##### agent/concurrent/
并行执行相关组件
- **concurrent_actor.py**: 并行执行协调器
- **llm_demension_parser.py**: 大语言模型维度解析器

##### agent/config/
配置管理
- **agent_config_manager.py**: 智能体配置管理器

##### agent/coordination/
任务协调相关组件
- **result_aggregator.py**: 结果聚合器
- **swarm_coordinator.py**: 群体协调器
- **task_coordinator.py**: 任务协调器，负责任务路由、规划和上下文处理

##### agent/excute/
执行相关组件
- **dify_actor.py**: Dify执行Actor

##### agent/io/
数据输入输出相关组件
- **__init__.py**: 模块初始化
- **data_actor.py**: 数据处理Actor
- **data_query_actor.py**: 数据查询Actor
- **data_routing_actor.py**: 数据路由Actor
- **dataconfig.py**: 数据配置
- **mysql_pool.py**: MySQL连接池实现
- **utils.py**: 工具函数
- **vanna_qwen_chroma.py**: Vanna与Qwen模型集成，用于文本到SQL转换

##### agent/mcp/
MCP（Master Control Program）模块
- **mcp_actor.py**: MCP Actor实现

##### agent/memory/
记忆系统实现
- **memory_actor.py**: 记忆Actor实现
- **memory_interface.py**: 记忆接口定义

##### agent/optimization/
优化相关组件
- **__init__.py**: 模块初始化
- **inductive_improver.py**: 归纳改进器
- **llmbase_evaluator.py**: LLM基础评估器
- **optimization_adapter.py**: 优化适配器
- **optimization_task.py**: 优化任务定义
- **optimizer.py**: 优化器
- **sqlite_task_persistence.py**: SQLite任务持久化

##### agent/task/
任务相关组件（空目录，可能待实现）

#### change_orchestrator/
变更编排器，负责系统变更的协调
- **__init__.py**: 模块初始化
- **decision_engine.py**: 决策引擎实现

#### llm/
大语言模型集成
- **__init__.py**: 模块初始化
- **qwen.py**: 通义千问模型集成

#### llm_memory_system/
LLM记忆系统，提供增强的记忆能力
- **__init__.py**: 模块初始化
- **example.py**: 使用示例
- **main.py**: 主入口
- **manager.py**: 记忆管理器
- **resourcememory.py**: 资源记忆
- **short_term.py**: 短期记忆
- **vault.py**: 记忆库

#### multifeature/
多特征分析和推理模块
- **__init__.py**: 模块初始化
- **belief_revision.py**: 信念修正
- **categories.py**: 类别处理
- **causal.py**: 因果关系分析
- **inference.py**: 推理引擎
- **logic.py**: 逻辑推理
- **main.py**: 主入口
- **metrics.py**: 指标计算
- **reflection.py**: 反射机制

## 3. 核心组件功能详解

### 3.1 智能体架构 (agent/)

#### AgentActor (agent/agent_actor.py)
系统的核心组件，实现了智能体的基本行为和任务处理能力。每个AgentActor可以是树形结构中的一个节点，负责接收、处理和转发任务。

关键功能：
- 消息接收与处理
- 任务执行与分发
- 智能体状态管理
- 与记忆系统交互

#### AgentRegistry (agent/agent_registry.py)
管理智能体的树形结构，提供智能体注册、查找和关系维护功能。

关键功能：
- 智能体注册与注销
- 树形结构维护
- 父子关系管理
- 智能体查找

### 3.2 任务协调 (agent/coordination/)

#### TaskCoordinator (agent/coordination/task_coordinator.py)
负责任务的路由、规划和上下文处理，是任务执行流程的核心协调者。

关键功能：
- 任务路由：根据能力选择合适的执行智能体
- 子任务规划：将复杂任务分解为子任务
- 上下文解析：丰富任务上下文信息
- 决策集成：与外部决策引擎交互

#### ResultAggregator (agent/coordination/result_aggregator.py)
收集和聚合任务执行结果，提供统一的结果处理机制。

### 3.3 并行执行 (agent/concurrent/)

#### ConcurrentActor (agent/concurrent/concurrent_actor.py)
实现并行任务执行的协调器，目前存在问题需要修复。

关键功能：
- 并行任务分发
- 结果聚合
- 与AgentActor集成

### 3.4 数据处理 (agent/io/)

#### DataActor (agent/io/data_actor.py)
负责数据处理和查询，是系统的数据访问层。

#### VannaQwenChroma (agent/io/vanna_qwen_chroma.py)
集成Vanna库和Qwen模型，实现文本到SQL的转换能力，支持数据库查询。

### 3.5 记忆系统 (agent/memory/, llm_memory_system/)

#### MemoryActor (agent/memory/memory_actor.py)
提供记忆功能的Actor实现，负责智能体的记忆管理。

#### LLM Memory System (llm_memory_system/)
增强的记忆系统，提供更复杂的记忆管理能力。

关键组件：
- Manager: 记忆管理器
- ResourceMemory: 资源记忆
- ShortTerm: 短期记忆
- Vault: 记忆库

### 3.6 优化系统 (agent/optimization/)

#### Optimizer (agent/optimization/optimizer.py)
优化器，负责系统优化和任务性能提升。

### 3.7 事件机制 (Observer/)

#### ObserverActor (Observer/observer_actor.py)
事件观察者实现，负责事件的发布和订阅。

#### TaskEvent (Observer/task_event.py)
任务事件定义，用于任务相关的事件通知。

### 3.8 大语言模型集成 (llm/)

#### Qwen (llm/qwen.py)
通义千问模型的集成实现，提供大语言模型能力。

### 3.9 决策系统 (change_orchestrator/)

#### DecisionEngine (change_orchestrator/decision_engine.py)
决策引擎实现，负责系统变更和任务决策。

## 4. 核心流程分析

### 4.1 任务执行流程
1. 用户请求通过入口层进入系统
2. 任务被分发到根AgentActor
3. TaskCoordinator进行任务解析和路由
4. 选择合适的AgentActor执行任务
5. 执行结果通过ResultAggregator聚合
6. 结果返回给用户

### 4.2 并行执行机制
1. ConcurrentActor接收需要并行执行的任务
2. 任务被分解为多个子任务
3. 每个子任务分配给一个AgentActor执行
4. 执行结果被收集和聚合
5. 返回最终结果

目前并行执行机制存在问题，需要修复VideoWorker相关问题，并与AgentActor正确集成。

### 4.3 数据处理流程
1. DataActor接收数据查询请求
2. 根据查询类型选择处理方式：
   - 直接数据库查询
   - 通过VannaQwenChroma进行文本到SQL转换
3. 执行查询并处理结果
4. 返回处理后的数据

## 5. 系统依赖关系

### 5.1 核心依赖
- Actor模型框架
- 大语言模型（通义千问）
- 数据库（MySQL）
- 向量数据库（ChromaDB）
- 优化库（可能使用Optuna）

### 5.2 组件间依赖
- AgentActor依赖TaskCoordinator进行任务处理
- TaskCoordinator依赖外部决策引擎
- DataActor依赖数据库和Vanna进行数据查询
- AgentActor依赖MemoryActor进行记忆管理

## 6. 问题与优化点

### 6.1 并行执行机制问题
- VideoWorker类被引用但不存在，需要替换为AgentActor
- ConcurrentActor中存在重复的receiveMessage方法
- 消息格式可能与AgentActor不兼容
- 导入缺失问题（如LLMOrchestrator、optuna等）

### 6.2 任务协调器拆分需求
- TaskCoordinator职责过重，需要拆分为三个组件：
  - TaskRouter: 负责任务路由和基于能力的actor选择
  - TaskPlanner: 负责子任务规划
  - ContextResolver: 负责上下文解析

### 6.3 架构优化方向
- 按六层架构重新组织文件体系
- 实现插件化接口
- 增强并行执行管理器
- 优化任务执行模型

## 7. 后续重构计划

按照重构执行计划，后续将进行以下工作：
1. 修复并行执行机制中的关键问题
2. 重构AgentActor类
3. 实现TaskCoordinator拆分
4. 完善循环任务管理器
5. 优化并行执行管理器
6. 实现插件化接口
7. 进行全面测试和性能优化

本架构文档提供了系统的整体视图，为后续的重构工作提供了基础。