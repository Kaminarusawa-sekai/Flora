# Flora 多智能体协作系统架构设计文档

## 1. 项目概述

Flora是一个基于Actor模型的多智能体协作系统，通过树形结构组织智能体，支持任务分发、并行执行和记忆增强等功能。系统主要用于复杂任务的分解、执行和优化，特别适合需要多步骤处理的业务场景。

## 2. 目录结构与功能说明

### 2.1 根目录结构

```
├── .gitignore                # Git忽略文件
├── Florareadme.md            # 项目说明文档
├── Observer/                 # 事件观察器模块
├── ReadMe.md                 # 项目README
├── action_implementations/   # 动作实现模块
├── agent/                    # 智能体核心模块
├── change_orchestrator/      # 变更编排模块
├── init_global_components.py # 全局组件初始化
├── llm/                      # 语言模型模块
├── llm_memory_system/        # LLM记忆系统
├── main.py                   # 主程序入口
├── multifeature/             # 多功能模块
├── 重构执行计划.md           # 重构执行计划
└── 重构方案.md               # 重构方案
```

### 2.2 核心模块详细说明

#### 2.2.1 agent/ - 智能体核心模块

**功能**: 系统的核心模块，包含智能体的基础实现、任务协调、并行执行等功能。

**关键文件**: 
- `agent_actor.py`: 智能体的核心实现，负责任务接收、处理和分发。
- `agent_registry.py`: 智能体注册表，管理智能体的树形结构和元数据。
- `message.py`: 定义系统中的各种消息类型。

**子目录**:
- `concurrent/`: 并行执行相关组件
  - `concurrent_actor.py`: 并行执行协调器，存在问题需要修复
  - `llm_demension_parser.py`: LLM维度解析器

- `config/`: 配置管理
  - `agent_config_manager.py`: 智能体配置管理器

- `coordination/`: 任务协调相关组件
  - `task_coordinator.py`: 任务协调器，负责任务规划和分配（需要拆分）
  - `result_aggregator.py`: 结果聚合器
  - `swarm_coordinator.py`: 群体协调器

- `excute/`: 执行相关组件
  - `dify_actor.py`: Dify工作流执行器

- `io/`: 数据输入输出相关组件
  - `data_actor.py`: 数据处理智能体
  - `data_query_actor.py`: 数据查询智能体
  - `data_routing_actor.py`: 数据路由智能体
  - `dataconfig.py`: 数据配置
  - `mysql_pool.py`: MySQL连接池
  - `vanna_qwen_chroma.py`: Vanna与Qwen模型集成，用于文本到SQL转换

- `mcp/`: 模型控制平面相关组件
  - `mcp_actor.py`: MCP智能体

- `memory/`: 记忆相关组件
  - `memory_actor.py`: 记忆智能体
  - `memory_interface.py`: 记忆接口定义

- `optimization/`: 优化相关组件
  - `optimizer.py`: 优化器
  - `optimization_task.py`: 优化任务
  - `optimization_adapter.py`: 优化适配器
  - `inductive_improver.py`: 归纳改进器
  - `llmbase_evaluator.py`: 基于LLM的评估器
  - `sqlite_task_persistence.py`: SQLite任务持久化

- `task/`: 任务相关组件

#### 2.2.2 Observer/ - 事件观察器模块

**功能**: 负责系统事件的记录、跟踪和查询。

**关键文件**:
- `observer_actor.py`: 任务观察器，监控任务执行状态
- `task_event.py`: 任务事件定义

#### 2.2.3 action_implementations/ - 动作实现模块

**功能**: 提供外部系统集成的具体实现。

**关键文件**:
- `dify_connector.py`: Dify平台连接器

#### 2.2.4 change_orchestrator/ - 变更编排模块

**功能**: 负责智能变更的决策和执行。

**关键文件**:
- `decision_engine.py`: 智能决策引擎

#### 2.2.5 llm/ - 语言模型模块

**功能**: 提供语言模型的接口和实现。

**关键文件**:
- `qwen.py`: 通义千问模型接口

#### 2.2.6 llm_memory_system/ - LLM记忆系统

**功能**: 提供多模态记忆管理功能。

**关键文件**:
- `manager.py`: 统一记忆管理器
- `short_term.py`: 短期记忆实现
- `resourcememory.py`: 资源记忆实现
- `vault.py`: 知识保险库实现

#### 2.2.7 multifeature/ - 多功能模块

**功能**: 提供各种高级功能组件。

**关键文件**:
- `belief_revision.py`: 信念修正
- `causal.py`: 因果推理
- `inference.py`: 推理功能
- `reflection.py`: 反思功能

## 3. 核心组件架构与关系

### 3.1 智能体架构

Flora系统采用树形结构组织智能体，通过AgentRegistry管理智能体之间的父子关系。每个智能体由AgentActor实现，具备任务处理、任务分发、结果聚合等能力。

**智能体树结构**:
- 根智能体: 接收顶层任务请求
- 中间智能体: 负责任务分解和协调
- 叶子智能体: 负责具体任务执行

### 3.2 主要组件关系

#### 3.2.1 AgentActor (agent/agent_actor.py)

**功能**: 智能体的核心实现，是整个系统的基础。

**主要职责**:
- 接收和处理各种类型的消息
- 初始化和管理内部组件
- 根据智能体类型（叶子/非叶子）执行不同的任务处理逻辑
- 集成记忆、数据查询、任务协调等能力

**依赖关系**:
- 依赖MemoryActor进行记忆管理
- 依赖TaskCoordinator进行任务协调
- 依赖DataQueryActor进行数据查询
- 依赖Optimizer进行优化

#### 3.2.2 AgentRegistry (agent/agent_registry.py)

**功能**: 管理智能体的注册表，提供智能体元数据和关系查询功能。

**主要职责**:
- 从Neo4j加载智能体信息
- 维护智能体之间的父子关系
- 管理智能体的Actor引用
- 提供智能体查询和导航功能

**关键特性**:
- 单例模式设计
- 支持角色区分的Actor引用管理
- 缓存机制提高查询性能

#### 3.2.3 TaskCoordinator (agent/coordination/task_coordinator.py)

**功能**: 任务协调器，负责任务的规划、分配和执行顺序确定。

**主要职责**:
- 基于能力选择最合适的子节点执行任务
- 使用Neo4j构建影响子图
- 调用决策引擎生成执行计划
- 解析和丰富任务上下文

**需要拆分的功能**:
- TaskRouter: 负责任务路由和智能体选择
- TaskPlanner: 负责子任务规划
- ContextResolver: 负责上下文解析和丰富

#### 3.2.4 OptimizationOrchestrator (agent/concurrent/concurrent_actor.py)

**功能**: 优化协调器，负责并行执行优化任务。

**存在问题**:
- 重复定义的receiveMessage方法
- 使用了不存在的VideoWorker类
- 缺少必要的导入

**需要修复**:
- 将VideoWorker替换为AgentActor
- 合并重复的receiveMessage方法
- 修复导入问题

#### 3.2.5 MemoryActor (agent/memory/memory_actor.py)

**功能**: 记忆智能体，封装统一记忆管理器的功能。

**主要职责**:
- 加载智能体记忆
- 摄入新的记忆内容
- 构建LLM上下文

**依赖关系**:
- 依赖UnifiedMemoryManager进行具体的记忆管理

#### 3.2.6 UnifiedMemoryManager (llm_memory_system/manager.py)

**功能**: 统一记忆管理器，融合多种记忆类型。

**主要职责**:
- 管理短期记忆
- 使用Mem0处理长期记忆
- 管理资源库和知识保险库
- 为LLM构建上下文

**记忆类型**:
- 短期记忆: 对话历史
- 长期记忆: 使用Mem0管理的语义、情景、核心记忆
- 资源记忆: 文档和资源内容
- 知识保险库: 重要知识存储

#### 3.2.7 TaskObserver (Observer/observer_actor.py)

**功能**: 任务观察器，监控任务执行状态。

**主要职责**:
- 记录任务开始、子任务生成、任务完成/失败等事件
- 维护活跃任务和任务历史
- 提供任务状态查询功能

## 4. 系统主要流程

### 4.1 任务执行流程

1. **任务接收**: AgentActor接收TaskMessage
2. **记忆补充**: 加载相关记忆（可选）
3. **数据查询**: 查询所需数据（可选）
4. **任务处理**: 
   - 叶子节点: 直接执行任务
   - 中间节点: 使用TaskCoordinator分解任务
5. **子任务分发**: 选择合适的子节点并分发任务
6. **结果聚合**: 收集和聚合子任务结果
7. **任务完成**: 返回最终结果给发送者

### 4.2 并行执行流程（待修复）

1. **批量任务接收**: OptimizationOrchestrator接收批量任务
2. **并行任务创建**: 为每个子任务创建AgentActor
3. **任务执行**: 并行执行所有子任务
4. **结果收集**: 收集所有子任务的结果
5. **结果聚合**: 聚合结果并返回给请求者

### 4.3 记忆使用流程

1. **记忆加载**: 通过LoadMemoryForAgent消息初始化记忆
2. **记忆摄入**: 通过IngestMemory消息摄入新内容
3. **上下文构建**: 通过BuildContextForLLM消息构建LLM上下文
4. **记忆查询**: 直接查询相关记忆（用于调试）

## 5. 重构重点和问题

### 5.1 并行执行机制修复

- **问题**: concurrent_actor.py中存在重复的receiveMessage方法定义
- **问题**: 使用了不存在的VideoWorker类
- **修复方案**: 
  - 合并重复的receiveMessage方法
  - 将VideoWorker替换为AgentActor
  - 修正消息格式，使其与AgentActor兼容
  - 修复导入缺失的问题

### 5.2 TaskCoordinator拆分

- **目标**: 将TaskCoordinator拆分为三个独立组件
- **拆分方案**:
  - TaskRouter: 负责任务路由和基于能力的智能体选择
  - TaskPlanner: 负责子任务规划和执行顺序确定
  - ContextResolver: 负责上下文解析和丰富

### 5.3 架构优化方向

- **文件结构优化**: 按照重构方案重新组织文件结构
- **接口标准化**: 实现插件化接口标准
- **组件解耦**: 减少组件间的直接依赖
- **性能优化**: 优化任务分发和结果聚合机制

## 6. 技术栈和依赖

### 6.1 核心框架
- Thespian: Actor模型实现
- Neo4j: 图数据库，用于存储智能体关系
- NetworkX: 图算法库，用于任务规划

### 6.2 语言模型
- Qwen: 通义千问大模型
- Mem0: 记忆管理框架
- Vanna: 文本到SQL转换

### 6.3 数据存储
- MySQL: 关系型数据库
- SQLite: 轻量级数据库，用于任务持久化
- ChromaDB: 向量数据库，用于知识存储

## 7. 总结

Flora系统是一个复杂的多智能体协作系统，采用树形结构组织智能体，支持任务分解、并行执行和记忆增强等功能。系统的主要优势在于其灵活性和可扩展性，但当前存在一些需要修复和优化的问题。通过实施重构计划，可以进一步提高系统的性能、可维护性和可扩展性。