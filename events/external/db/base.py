from abc import ABC, abstractmethod
from datetime import datetime
from typing import List, Optional
from common.event_definition import EventDefinition
from common.event_instance import EventInstance
from common.event_log import EventLog
from common.enums import EventInstanceStatus


class EventDefinitionRepository(ABC):
    @abstractmethod
    async def create(self, definition: EventDefinition) -> None: ...
    @abstractmethod
    async def get(self, def_id: str) -> EventDefinition: ...
    @abstractmethod
    async def list_active_cron(self) -> List[EventDefinition]: ...


class EventInstanceRepository(ABC):
    @abstractmethod
    async def create(self, instance: EventInstance) -> None: ...
    @abstractmethod
    async def bulk_create(self, instances: List[EventInstance]) -> None: ...
    @abstractmethod
    async def get(self, instance_id: str) -> EventInstance: ...
    @abstractmethod
    async def get_by_task_id(self, task_id: str) -> Optional[EventInstance]: ...
    @abstractmethod
    async def get_by_ids(self, ids: List[str]) -> List[EventInstance]: ...
    @abstractmethod
    async def find_by_trace_id(self, trace_id: str) -> List[EventInstance]: ...
    @abstractmethod
    async def find_by_trace_id_with_filters(self, trace_id: str, filters: dict, limit: int = 100, offset: int = 0) -> List[EventInstance]: ...
    @abstractmethod
    async def lock_for_execution(self, instance_id: str, worker_id: str) -> bool: ...
    @abstractmethod
    async def update_status(self, instance_id: str, status: EventInstanceStatus, **kwargs) -> None: ...
    @abstractmethod
    async def increment_completed_children(self, parent_id: str) -> int: ...
    @abstractmethod
    async def find_ready_tasks(self) -> List[EventInstance]: ...
    @abstractmethod
    async def bulk_update_status_by_trace(self, trace_id: str, status: EventInstanceStatus) -> None: ...
    @abstractmethod
    async def find_pending_with_deps_satisfied(self) -> List[EventInstance]: ...
    @abstractmethod
    async def update_fields(self, instance_id: str, **fields) -> None: ...
    @abstractmethod
    async def bulk_update_signal_by_path(self, trace_id: str, path_pattern: str, signal: str) -> None: ...
    @abstractmethod
    async def update_signal_by_trace(self, trace_id: str, signal: str) -> None: ...
    @abstractmethod
    async def find_traces_by_user_id(self, user_id: str, start_time: Optional[datetime] = None, end_time: Optional[datetime] = None, limit: int = 100, offset: int = 0) -> List[dict]: ...
    @abstractmethod
    async def upsert_by_task_id(self, task_id: str, trace_id: str, **fields) -> str: ...


class EventLogRepository(ABC):
    @abstractmethod
    async def create(self, log: EventLog) -> None: ...
    @abstractmethod
    async def get(self, log_id: str) -> EventLog: ...
    @abstractmethod
    async def find_by_instance_id(self, instance_id: str) -> List[EventLog]: ...
    @abstractmethod
    async def find_by_trace_id(self, trace_id: str) -> List[EventLog]: ...
    @abstractmethod
    async def find_by_trace_id_with_filters(self, trace_id: str, filters: dict, limit: int = 100, offset: int = 0) -> List[EventLog]: ...
    @abstractmethod
    async def count_by_event_type(self, instance_id: str, event_type: str) -> int: ...


class AgentTaskHistoryRepository(ABC):
    @abstractmethod
    async def create(self, history_data: dict) -> None: ...
    @abstractmethod
    async def get_recent_tasks(self, agent_id: str, limit: int = 20) -> List[dict]: ...
    @abstractmethod
    async def get_task_statistics(self, agent_id: str, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> dict: ...
    @abstractmethod
    async def get_avg_duration(self, task_name: str) -> float: ...


class AgentDailyMetricRepository(ABC):
    @abstractmethod
    async def update_daily_metric(self, agent_id: str, date_str: str, status: str, duration_ms: int) -> None: ...
    @abstractmethod
    async def get_recent_metrics(self, agent_id: str, days: int = 7) -> List[dict]: ...