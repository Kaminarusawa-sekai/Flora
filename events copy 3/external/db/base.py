from abc import ABC, abstractmethod
from typing import List, Optional
from ...common.task_definition import TaskDefinition
from ...common.task_instance import TaskInstance
from ...common.enums import TaskInstanceStatus


class TaskDefinitionRepository(ABC):
    @abstractmethod
    async def create(self, definition: TaskDefinition) -> None: ...
    @abstractmethod
    async def get(self, def_id: str) -> TaskDefinition: ...
    @abstractmethod
    async def list_active_cron(self) -> List[TaskDefinition]: ...
    @abstractmethod
    async def get_by_job_id(self, job_id: str) -> TaskDefinition: ...


class TaskInstanceRepository(ABC):
    @abstractmethod
    async def create(self, instance: TaskInstance) -> None: ...
    @abstractmethod
    async def get(self, instance_id: str) -> TaskInstance: ...
    @abstractmethod
    async def get_by_ids(self, ids: List[str]) -> List[TaskInstance]: ...
    @abstractmethod
    async def find_by_trace_id(self, trace_id: str) -> List[TaskInstance]: ...
    @abstractmethod
    async def find_by_trace_id_with_filters(self, trace_id: str, filters: dict, limit: int = 100, offset: int = 0) -> List[TaskInstance]: ...
    @abstractmethod
    async def lock_for_execution(self, instance_id: str, worker_id: str) -> bool: ...
    @abstractmethod
    async def update_status(self, instance_id: str, status: TaskInstanceStatus, **kwargs) -> None: ...
    @abstractmethod
    async def increment_completed_children(self, parent_id: str) -> int: ...
    @abstractmethod
    async def find_ready_tasks(self) -> List[TaskInstance]: ...
    @abstractmethod
    async def bulk_update_status_by_trace(self, trace_id: str, status: TaskInstanceStatus) -> None: ...
    @abstractmethod
    async def find_pending_with_deps_satisfied(self) -> List[TaskInstance]: ...
    @abstractmethod
    async def update_fields(self, instance_id: str, **fields) -> None: ...
    @abstractmethod
    async def bulk_update_signal_by_path(self, trace_id: str, path_pattern: str, signal: str) -> None: ...
    @abstractmethod
    async def update_signal_by_trace(self, trace_id: str, signal: str) -> None: ...