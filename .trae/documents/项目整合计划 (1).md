# 项目整合计划

## 问题分析

根据对项目代码的分析，当前项目存在以下问题：

1. **配置缺失**：
   - `init_global_components.py` 中使用了 `ACTOR_CLASS` 变量，但在 `config.py` 中未定义
   - 缺少必要的配置项

2. **能力注册机制未实现**：
   - `capabilities.registry` 已实现能力注册机制，但缺少实际注册代码
   - 各个能力模块（如 routing、parallel 等）未注册到全局注册表

3. **依赖注入不完整**：
   - 模块间依赖关系不清晰
   - 缺少统一的依赖注入机制

4. **事件系统集成问题**：
   - `agent_actor.py` 中使用 `event_bus` 但未导入
   - 事件类型定义可能不完整

5. **任务执行流程缺失**：
   - `_dispatch_subtasks` 方法使用了 `TaskExecutionService`，但该类未实现
   - 任务执行、结果处理流程不完整

6. **循环任务集成问题**：
   - `LoopSchedulerActor` 与 RabbitMQ 集成不完整
   - `rabbit_bridge.py` 中的 `start_rabbit_bridge` 函数未被正确使用

7. **主入口问题**：
   - `main.py` 中的 `start_project` 函数未被调用
   - FastAPI 应用缺少必要的路由定义

## 解决方案

### 1. 完善配置

- 在 `config.py` 中添加 `ACTOR_CLASS` 配置项
- 确保所有必要的配置项都已定义

### 2. 实现能力注册

- 在 `init_global_components.py` 中添加能力注册逻辑
- 注册所有需要的能力模块，包括：
  - routing (TaskRouter, TaskPlanner)
  - parallel (ParallelOptimizationInterface)
  - llm_memory (MemoryCapability)

### 3. 完善依赖注入

- 确保各个模块之间的依赖关系清晰
- 使用 `capability_registry` 进行依赖注入
- 完善 `agent_actor.py` 中的依赖注入逻辑

### 4. 完善事件系统

- 在 `agent_actor.py` 中正确导入 `event_bus`
- 确保事件类型定义完整
- 完善任务事件通知逻辑

### 5. 完善任务执行流程

- 实现 `TaskExecutionService` 类
- 确保任务执行、结果处理流程完整
- 完善 `result_aggregator_actor.py` 与其他模块的集成

### 6. 完善循环任务

- 确保 `LoopSchedulerActor` 与 RabbitMQ 正确集成
- 在 `main.py` 中正确导入和使用 `start_rabbit_bridge` 函数
- 完善循环任务的自优化逻辑

### 7. 完善主入口

- 在 `main.py` 中调用 `start_project` 函数
- 添加必要的 FastAPI 路由定义
- 确保项目能够正常启动和运行

## 实施步骤

1. **完善配置**：修改 `config.py`，添加必要的配置项
2. **实现能力注册**：修改 `init_global_components.py`，添加能力注册逻辑
3. **完善依赖注入**：修改各个模块，使用 `capability_registry` 进行依赖注入
4. **完善事件系统**：修改 `agent_actor.py`，正确导入和使用 `event_bus`
5. **完善任务执行流程**：实现 `TaskExecutionService` 类
6. **完善循环任务**：修改 `main.py`，正确集成 RabbitMQ 桥接器
7. **完善主入口**：修改 `main.py`，添加必要的路由定义
8. **测试和调试**：确保项目能够正常启动和运行

## 预期结果

- 项目能够正常启动和运行
- 各个模块之间能够正确通信和协作
- 任务能够按照预期流程执行
- 循环任务能够正确调度和执行
- 事件能够正确发布和订阅
- 能力模块能够通过插件式方式扩展

## 风险评估

- 配置项缺失可能导致启动失败
- 能力注册不完整可能导致功能缺失
- 依赖关系不清晰可能导致运行时错误
- 事件系统集成问题可能导致事件丢失
- 任务执行流程不完整可能导致任务失败
- 循环任务集成问题可能导致调度失败

## 缓解措施

- 完善配置检查机制，确保所有必要的配置项都已定义
- 实现能力注册的验证机制，确保所有必要的能力都已注册
- 完善依赖注入的错误处理机制，确保依赖缺失时能够给出明确的错误信息
- 完善事件系统的日志记录，确保事件发布和订阅的情况能够被记录
- 完善任务执行流程的错误处理机制，确保任务失败时能够给出明确的错误信息
- 完善循环任务的监控机制，确保循环任务能够被正确调度和执行